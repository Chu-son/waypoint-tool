# システム要件定義 (Requirements)

本ドキュメントは、ROS Waypoint Tool の主な要件とゴールを定義します。

## 概要 (Overview)
ROS(ROS2)のNavigationパッケージと組み合わせて使用する、自律移動ロボット向け「Waypoint作成ツール」のPC向けデスクトップアプリケーション。TauriとReact(PixiJS)を利用した単一の実行バイナリとして配布可能。

## 機能要件 (Functional Requirements)

### 1. マップ表示 (Map Visualization)
- ROS標準の 2D Occupancy Grid Map ファイル（YAMLメタデータ + PGM/PNG画像）を読み込めること。
- 白（空き領域）、黒（障害物）、グレー（未知領域）のマップ上に、Waypointや軌跡を描画できること。
- マウスドラッグによる「パン（移動）」と、マウスホイールによる「ズーム（拡大・縮小）」操作が可能であること。

### 2. Waypointの作成・編集 (Waypoint Editing)
- キャンバス上をクリックすることで、任意の位置にWaypoint（通過点）を作成できること。
- Waypointには「位置（X, Y座標）」と「姿勢（ヨー角/Yaw）」が視覚的に表現されること（例: 矢印マーカー）。
- Waypointの基本情報（ID, 座標, 角度）をエディタパネル（Inspector）から直接数値編集できること。
- 複数の要素を選択し（Ctrl+クリックなど）、一括編集や削除が可能であること。
- ヒエラルキーツリー内でのドラッグ＆ドロップによる順序の入れ替えが可能であること。

### 3. オプションプロパティの拡張 (Option Properties)
- Waypointごとに「目標速度」「停止時間」「動作モード（ドッキング、リレージャンプ等）」といった任意の追加属性(Options)を設定できること。
  - 値の型として `string`, `float`, `integer`, `boolean`, `list` (要素の型を指定できる配列) に対応し、GUIのSettingsダイアログから動的に追加・編集できること。
- これらの属性スキーマはプロジェクトファイル(`.wptroj`)内で管理され、フロントエンドのプロパティパネルに動的に入力フォームを生成すること。

### 4. 自動生成機能・非破壊編集 (Generators & Non-Destructive Editing)
- 手動のポイント追加に加え、「矩形領域を一定間隔で走査する」などの高度なWaypoint自動生成（ジェネレータ）機能をサポートすること（非破壊のまま保持可能）。
- Generator Node と Manual Node のツリー構造を内部で持ち、GUIの左ペイン（Hierarchy）に表現されること。

### 5. 入出力 (Data Export / Import)
- 作業状態全体を保存できる内部プロジェクトファイル(`.wptroj`)の保存・読み込み機能。
- ロボットへ転送する最終出力を生成するエクスポート機能（YAML, JSON, CSVなどのデフォルトフォーマットの選択対応）。
- 独自形式の カスタムテンプレート (Handlebars) を **プロジェクト内に複数保持** し、エクスポート画面から任意のテンプレートを選んで出力できること。

## 非機能要件 (Non-Functional Requirements)

- **クロスプラットフォーム動作**: Windows, Linuxでネイティブに動作すること（Tauriの採用）。
- **高パフォーマンス**: 数千個のWaypointや巨大なPGMマップを読み込んでもUIがフリーズしないこと（PixiJS等のWebGLレンダラとRustの活用）。
- **拡張性**: 将来の3Dグラフィクス（React Three Fiber等）の切り替えや、新しい自動生成アルゴリズムの追加が容易な「疎結合な設計」になっていること。

## 追加実装・運用要件 (Additional Operations & UX Requirements)

### 6. ウィンドウ状態の保持 (Window State Persistence)
- アプリ終了時のウィンドウ位置やサイズ、最大化状態を記憶し、次回起動時に前回の状態を復元すること（`tauri-plugin-window-state` 等の活用）。

### 7. プラットフォーム別の配布形式 (Distribution Formats)
- 以下3つの形式でリリースバイナリを用意する方針とします：
  1. **単一実行ファイル (`exe`/`AppImage`)**: 手軽な実行・インストール不要な用途。
  2. **ZIPアーカイブ (単一実行ファイル + 設定ファイル類)**: ユーザー定義の設定(`.yaml`/`.json`)や**Python自動生成プラグイン**, **カスタムテンプレート(`exports.hbs`)** などの外部リソースを内包し、プロジェクトごとに自己完結したポータブルな配布形態。
  3. **インストーラ形式 (`msi`/`deb`)**: システムへの統合、関連拡張子(`.wptroj`)の関連付け、ショートカット作成を想定した標準インストール用途。

### 8. UIレイアウトとユーザビリティ (UI Layout & Usability)
- **Top Menu**: プロジェクトの保存・読み込みなどのファイル操作は、画面上部の専用メニューバーで行うこと。
- **Toolbar**: マップ読み込み等の外部ファイル操作は「レイヤー(Layers)」関連や「設定(Settings)」付近に文脈に応じて適切に配置すること。
- **Canvas Exporting & Attributes**: PixiJS等のCanvas描画内容は、ユーザーが任意に画像化してエクスポートできる状態（`preserveDrawingBuffer`などの有効化）にし、表示情報を切り替え可能なこと。
  - 値の描画時にはラベル（プロパティ名）が付与されて視認できること。
  - ユーザー設定で、可視化時やエクスポート時の Waypoint Index （連番）の開始を「0」または「1」から選択可能であること。

### 9. プラグイン・外部スクリプト連携 (Plugin System)
- **Python / Rust (WASM) プラグインの実行**: 外部スクリプト（Python または `.wasm`）を「Generator」として呼び出し、任意の自動生成アルゴリズムを組み込めること。
  - プラグインは `manifest.json` でメタデータ（名前・入力・プロパティ・UI型）を宣言し、フロントエンドが動的に入力フォームを生成すること。
  - 出力は `stdout` を経由した JSON 配列形式の Waypoint データ。
- **インタラクション入力（MapCanvas 上の点入力）**: `manifest.json` で `type: "point"` の入力を宣言したプラグインに対し、ユーザーがキャンバス上をクリックして始点などを直接指定できること。
- **プラグイン管理 UI**: Settings ダイアログからプラグインの有効・無効・順序変更・カスタムフォルダの追加が可能であること。
- **組み込みプラグインのバンドル**: アプリ配布バイナリにデフォルトプラグイン（例: `sweep_generator`）を同梱し、初回起動時から利用可能であること。
- **Python 実行環境の設定**: グローバル Python パスを Settings で指定可能なこと。またプラグインごとに Python インタープリタを個別上書き設定できること。システム上の Python 環境を自動探索してドロップダウンに提示する機能を含む。
- **Generator ノードの再編集**: 生成済みの Generator ノードを選択すると、その生成パラメータ（プロパティ値・インタラクション入力値）が Properties Panel で確認・変更でき、「Re-Generate」ボタンで再実行できること。

### 10. エクスポートサフィックスのカスタマイズ (Configurable Export Suffixes)
- エクスポート時にファイル名へ付与されるサフィックス文字列を、フォーマットごとに自由に設定できること。
  - デフォルトのフォーマット（YAML / JSON）に対してそれぞれ個別のサフィックスを設定できること（デフォルト: `_yaml`, `_json`）。
  - カスタム Handlebars テンプレートに対しても任意のサフィックスを設定できること。
  - 設定した値はプロジェクトファイル (`.wptroj`) に保存・復元されること。
- 設定は **Settings → Export Templates** タブで編集できること。
- エクスポートモーダルでは、設定されたサフィックスをそのままファイル名生成に使用し、ハードコードした命名ルールを使わないこと。

### 11. ジェネレーターノード編集時のリアルタイムキャンバスプレビュー (Generator Edit Preview)
- Properties Panel でジェネレーターノードのインタラクションポイント（例: `start_point` の X・Y・Yaw）を数値入力で変更した際、**Re-Generate を実行する前でも**、キャンバス上にプレビュー（ピンク矢印マーカー）がリアルタイムに更新されて表示されること。
- このプレビューは、Generator ノードが選択状態にある限り表示し続けること（`add_generator` ツール使用時のみに限定しないこと）。
